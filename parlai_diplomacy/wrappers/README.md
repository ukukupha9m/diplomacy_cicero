# ParlAI Wrappers

"**Wrappers**" are wrappers around [ParlAI agents](https://parl.ai/docs/tutorial_basic.html#agents) that allow them to seamlessly integrate with the game environment.  For example, a wrapper for the dialogue model has an API `generate_message` that takes in a game object, a power (speaker), and returns a message object generated by the model.

## Base wrapper

The [`BaseWrapper`](https://github.com/facebookresearch/diplomacy_cicero/blob/main/parlai_diplomacy/wrappers/base_wrapper.py) contains some basic functionality shared by all ParlAI wrappers.

The `__init__` function takes in a `model_path` corresponding to the model checkpoint and an optional dictionary for `additional_args`.  ParlAI overrides in particular are contained in `additional_args['overrides']`:

```
def __init__(self, model_path: str, additional_args=None):
    ...
```

The parsing of the game object into a string is handled by `self.formatter`, which is initialized using the task name contained in `self.opt['task']`; in other words, it is directly governed by the task the model was trained on:

```
def _initialize_formatter(self):
    self.formatter = sequence_formatter_factory(
        self.task_name, self.metadata["task_version"], training=False
    )
```

High level game and player metadata, such as the player rating associated with the agent, how long the phases are, the draw type, etc. are set in the function `_get_player_metadata`. Some of these attributes are set using `self.opt` (which is loaded from `<model_file>.opt` and overridden by `additional_args`), and some are hardcoded. For example, at inference time, we always play "anonymous" games.

The function `get_model_pred` defines an API for directly soliciting output from the ParlAI model, provided an input string and possibly a list of candidates to score:

```
def get_model_pred(
    self,
    input_seq: str,
    candidates: Optional[List[str]] = None,
    prefix_str: Optional[str] = None,
) -> ParlAIAct:
    """
    Return the model's prediction for an input sequence.
    Args:
    - input_seq (str): input sequence for which we are getting a prediction
    - candidates (Optional[List[str]]): optional list of candidates for scoring
    - prefix_str (Optional[str]): optional prefix string for decoding
    """
```

## Wrapper types

Individual wrappers for different model types inherit from the base wrapper. For example, we have wrappers for
* Generative dialogue models
* Generative orders models
* Sleep, recipient, nonsense, and draw classifiers

Each wrapper should at least one clearly defined unique API corresponding to its purpose. For example, a nonsense classifier wrapper has the API `get_nonsense_status`, whereas an orders model wrapper has APIs for `produce_orders`, `produce_many_orders`, as well as `score_candidate_orders`.


## Loading a wrapper

Functions for loading wrappers can be found in the [wrapper factory](https://github.com/facebookresearch/diplomacy_cicero/blob/main/parlai_diplomacy/wrappers/factory.py).  In particular, they can be loaded with a `ParlaiModel` config (defined in `fairdiplomacy/conf/agents.proto`.)  In special cases, they can be instantiated directly with the model file and any additional override args.